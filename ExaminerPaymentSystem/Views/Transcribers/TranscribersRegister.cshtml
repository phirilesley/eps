@model IEnumerable<RegisterViewModel>

    @{
    string examCode = ViewBag.ExamCode ?? "";

    string activity = ViewBag.Activity ?? "";
    }


<style>


    .status-approved {
        color: white;
        background-color: green;
        padding: 5px 10px;
        border-radius: 4px;
    }

    .status-rejected {
        color: white;
        background-color: red;
        padding: 5px 10px;
        border-radius: 4px;
    }

    .status-pending {
        color: black;
        background-color: orange;
        padding: 5px 10px;
        border-radius: 4px;
    }

</style>

<div class="text-center mb-4 mt-4">
    <div class="d-flex align-items-center justify-content-center gap-2">
   
        <i class="fas fa-clipboard-list" style="color: #2a5a8a;"></i>
        <h4 class="fw-bold mb-0" style="color: #153355;">
            Attendance Register 
        </h4>
    </div>
    <hr style="border-top: 1px solid black;
    width: 100px;
    margin: 8px auto;
    ">
</div>


<div class="card mt-4 mb-1 p-2 shadow-sm border">
    <div class="card-header">
        <div class="row text-center">
            <!-- Total Invited -->
            <div class="col-6 col-md-2 mb-3">
                <div id="totalExaminersCounter" class="counter btn btn-primary text-white d-flex flex-column justify-content-center align-items-center py-3" style="height: 60px;" onclick="filterData('TotalInvited')">
                    <h6 class="mb-0">Loading...</h6>
                    <p class="mb-0">Total Invited</p>
                </div>
            </div>
            <!-- Confirmed Attending -->
            <div class="col-6 col-md-2 mb-3">
                <div id="comingExaminersCounter" class="counter btn btn-success text-white d-flex flex-column justify-content-center align-items-center py-3" style="height: 60px;" onclick="filterData('ConfirmedAttending')">
                    <h6 class="mb-0">Loading...</h6>
                    <p class="mb-0">Confirmed</p>
                </div>
            </div>
            <!-- Pending -->
            <div class="col-6 col-md-2 mb-3">
                <div id="pendingExaminersCounter" class="counter btn btn-warning text-dark d-flex flex-column justify-content-center align-items-center py-3" style="height: 60px;" onclick="filterData('Pending')">
                    <h6 class="mb-0">Loading...</h6>
                    <p class="mb-0">Pending</p>
                </div>
            </div>
            <!-- Not Attending -->
            <div class="col-6 col-md-2 mb-3">
                <div id="notcomingExaminersCounter" class="counter btn btn-danger text-white d-flex flex-column justify-content-center align-items-center py-3" style="height: 60px;" onclick="filterData('NotAttending')">
                    <h6 class="mb-0">Loading...</h6>
                    <p class="mb-0">Not Attending</p>
                </div>
            </div>
            <!-- Recommended -->
            <div class="col-6 col-md-2 mb-3">
                <div id="presentExaminersCounter" class="counter btn btn-info text-white d-flex flex-column justify-content-center align-items-center py-3" style="height: 60px;" onclick="filterData('Recommended')">
                    <h6 class="mb-0">Loading...</h6>
                    <p class="mb-0">Recommended</p>
                </div>
            </div>
            <!-- Absent -->
            <div class="col-6 col-md-2 mb-3">
                <div id="absentExaminersCounter" class="counter btn btn-secondary text-white d-flex flex-column justify-content-center align-items-center py-3" style="height: 60px;" onclick="filterData('Absent')">
                    <h6 class="mb-0">Loading...</h6>
                    <p class="mb-0">Absent</p>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="card p-4 shadow-sm border-1">
    <div class="card-body">
        <div class="table-responsive">
            <table id="regTable" class="table table-bordered table-striped table-hover">
                <thead class="table-light">
                    <tr>
                   
                        <th>Last Name</th>
                        <th>First Name</th>

                        <th>National ID</th>

                        <th>Category</th>
                        <th>Attendance</th>

                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

</div>





@section Scripts {
    <script>
        function updatePresence(subKey, isPresent) {
            fetch('@Url.Action("UpdatePresence", "Transcribers")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                      subKey: subKey,
                    isPresent: isPresent
                })
            })
                .then(response => {
                    if (response.ok) {
                        // Determine the message and color based on isPresent value
                        const statusMessage = isPresent ? 'Present' : 'Absent';
                        const titleMessage = `Examiner ${statusMessage}`;
                        const textMessage = `Examiner Updated ${statusMessage} Successfully.`;
                        const backgroundColor = isPresent ? '#153355' : '#dc3545'; // Green for Present, Red for Absent

                        Swal.fire({
                            icon: 'success',
                            title: titleMessage,
                            text: textMessage,
                            showConfirmButton: false,
                            timer: 500, // Close the popup after 3 seconds
                            // Custom background color based on status
                            background: backgroundColor,
                            color: '#ffffff', // White text color for contrast
                            customClass: {
                                popup: 'custom-swal-popup' // Custom class for additional styling
                            }
                        }).then(() => {
                            updateCounts();
                        });
                    } else {
                        throw new Error('Failed to update presence status.');
                    }
                })
                .catch(error => {
                    console.error('Error updating presence status:', error);
                    alert('Failed to update presence status.');
                });
        }
    </script>



    <script>
        function updateCounts() {
             // Construct the URL with parameters from the ViewBag
                    const url = `@Url.Action("CountAbsentAndPresent", "Transcribers")?examCode=@ViewBag.ExamCode&activity=@ViewBag.Activity`;

                    fetch(url, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    const setCounterValue = (id, label, value) => {
                        const counterElement = document.getElementById(id);
                        if (counterElement) {
                            counterElement.innerHTML = `<h6 class="mb-0">${value}</h6><p class="mb-0">${label}</p>`;
                        }
                    };

                    setCounterValue('totalExaminersCounter', 'Total Invited', data.total);
                    setCounterValue('presentExaminersCounter', 'Recommended', data.presentCount);
                    setCounterValue('absentExaminersCounter', 'Absent', data.absentCount);
                    setCounterValue('comingExaminersCounter', 'Confirmed', data.comingCount);
                    setCounterValue('notcomingExaminersCounter', 'Not Attending', data.notcomingCount);
                    setCounterValue('pendingExaminersCounter', 'Pending', data.pendingCount);
                })
                .catch(error => {
                    console.error('Error fetching counts:', error);
                });
        }

        updateCounts();
    </script>



    <script>
        $('#regTable').DataTable({
            "processing": true,
            "serverSide": true,
            "lengthMenu": [
                [10, 25, 50, 100, 250, 500, 1000],
                [10, 25, 50, 100, 250, 500, 1000]
            ],
            "pageLength": 100,
            "dom": '<"row mb-3"<"col-md-4"l><"col-md-4 text-center"B><"col-md-4"f>>' +
                '<"table-responsive"t>' +
                '<"row mt-3"<"col-md-6"i><"col-md-6"p>>',
            "buttons": [
                {
                    extend: 'excelHtml5',
                    className: 'btn btn-sm btn-success',
                    text: '<i class="fa fa-file-excel" style="color: #28a745;"></i> Excel',
                    exportOptions: { columns: ':visible' }
                },
                {
                    extend: 'csvHtml5',
                    className: 'btn btn-sm btn-info',
                    text: '<i class="fa fa-file-csv" style="color: #17a2b8;"></i> CSV',
                    exportOptions: { columns: ':visible' }
                },
                {
                    extend: 'pdfHtml5',
                    className: 'btn btn-sm btn-danger',
                    text: '<i class="fa fa-file-pdf" style="color: #dc3545;"></i> PDF',
                    exportOptions: { columns: ':visible' }
                }
            ],
            "ajax": {
                url: "/Transcribers/GetTranscribersRegister",
                type: "POST",
                data: function (d) {
                    // Add your custom parameters here
                    d.examCode = "@examCode"; // Pass examCode from ViewBag
                 
                    d.activity = "@activity"; // Pass activity from ViewBag
          

                }
            },
            "columns": [

           
                {
                    "data": "lastName", "name": "LastName", "autoWidth": true
                },

                {
                    "data": "firstName", "name": "FirstName", "autoWidth": true
                },

                {
                    "data": "idNumber", "name": "IdNumber", className: "text-nowrap"
                },


                {
                    "data": "category", "name": "Category", "autoWidth": true
                },
                {
                    "data": "attendanceStatus",
                    "name": "AttendanceStatus",
                    "autoWidth": true,
                    "render": function (data) {
                        // Define classes based on the attendanceStatus value
                        var statusClass = data === 'Yes' ? 'badge bg-success' :
                            data === 'No' ? 'badge bg-danger' :
                                'badge bg-warning';

                        // Return a span with the appropriate class and data
                        return `<span class="${statusClass}">${data}</span>`;
                    }
                },




                {
                    "render": function (data, type, row) {
                        return `
                           <div class="btn-group" role="group">
                        <input type="checkbox" class="text-white" style="background-color: #153355;"  ${row.status === "Present" ? "checked" : ""}
                            onchange="updatePresence('${row.subKey}', this.checked)" />
                    </div>
                        `;
                    }
                }

            ]
        });


        function filterData(status) {
            $('#regTable').DataTable().ajax.url(`/Transcribers/GetTranscribersRegister?status=${encodeURIComponent(status)}`).load();
        }

    </script>

}



