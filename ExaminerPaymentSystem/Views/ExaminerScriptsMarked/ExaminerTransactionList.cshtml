
@inject SignInManager<ApplicationUser> SignInManager


@{
    ViewBag.Title = "Examiners";

    string examCode = ViewBag.ExamCode ?? "";
    string subjectCode = ViewBag.SubjectCode ?? "";
    string paperCode = ViewBag.PaperCode ?? "";
    string regionCode = ViewBag.RegionCode ?? "";

}




<script>
    $(document).ready(function () {
    @if (TempData["SuccessMessage"] != null)
    {
        <text>
                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: '@TempData["SuccessMessage"]',
                    showConfirmButton: false,
                    timer: 2000
                });
        </text>
    }

    @if (TempData["Error"] != null)
    {
        <text>
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: '@TempData["Error"]',
                    showConfirmButton: true
                });
        </text>
    }
            });
</script>






<div class="text-center mb-">
    <h5 class="fw-bold text-black">Examiners:  <span class="text-black">@subjectCode / @paperCode</span></h5>
    <hr class="border-2 border-primary w-50 mx-auto" />
</div>

<!-- Buttons Section -->
<div class="card mt-4 mb-2 shadow border-0">
    <div class="card-header bg-white border-0">
        <div class="row justify-content-end">
            @if (User.IsInRole("SubjectManager") || User.IsInRole("CentreSupervisor") || User.IsInRole("Admin") ||
            User.IsInRole("PMS") || User.IsInRole("RPMS") || User.IsInRole("DPMS") || User.IsInRole("BMS"))
            {
                <div class="col-auto d-flex justify-content-end mt-2">
                    <!-- Replace Absent Examiner Button -->
          

                    <!-- Add Examiner Button -->
                    <a class="btn btn-success px-3 py-2 d-flex align-items-center text-white"
                       style="border-radius: 50px;background-color: #153355; transition: background-color 0.3s;"
                       asp-controller="Examiner"
                       asp-action="AddNewExaminerTransaction"
                       asp-route-examCode="@examCode"
                       asp-route-subjectCode="@subjectCode"
                       asp-route-paperCode="@paperCode">
                        <i class="fas fa-plus me-2"></i> Add Examiner
                    </a>
                </div>
            }
        </div>
    </div>
</div>

<!-- Table Section -->
<div class="card p-4 shadow-sm border-0">
    <div class="card-body">
        <div class="table-responsive">
            <table id="examinersTable" class="table table-bordered table-striped table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Examiner Number</th>
                        <th>Last Name</th>
                        <th>First Name</th>
                        <th>Category</th>
                        <th>BMS Code</th>
                        <th>Activity</th>
                        <th>Scripts Marked</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dynamic data will populate here -->
                </tbody>
            </table>
        </div>
    </div>
</div>






<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM fully loaded and parsed');

        function attachDeleteEvent() {
            const deleteButtons = document.querySelectorAll('.delete-button');
            if (deleteButtons.length > 0) {
                console.log(`Found ${deleteButtons.length} delete buttons`);

                deleteButtons.forEach(button => {
                    button.addEventListener('click', function (e) {
                        e.preventDefault();
                        console.log('Delete button clicked');

                        const idNumber = this.getAttribute('data-idnumber');
                        const examinerCode = this.getAttribute('data-examinercode');
                        const subKey = this.getAttribute('data-subkey');

                        Swal.fire({
                            title: 'Are you sure?',
                            text: "You won't be able to revert this!",
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Yes, delete it!'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                console.log('Confirmed delete');
                                // Make a GET request to delete the item
                                fetch(`/Examiner/DeleteExaminer?idNumber=${idNumber}&examinerCode=${examinerCode}&subKey=${subKey}`, {
                                    method: 'GET',
                                })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            Swal.fire(
                                                'Deleted!',
                                                'The record has been deleted.',
                                                'success'
                                            ).then(() => {
                                                location.reload();
                                            });
                                        } else {
                                            Swal.fire(
                                                'Error!',
                                                'There was an error deleting the record.',
                                                'error'
                                            );
                                        }
                                    });
                            }
                        });
                    });
                });
            } else {
                console.log('No delete buttons found');
            }
        }

        // Initial attachment of events
        attachDeleteEvent();

        // Use MutationObserver to detect any added nodes and re-attach events
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.addedNodes.length > 0) {
                    attachDeleteEvent();
                }
            });
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    });

</script>





@if (User.IsInRole("SubjectManager") || User.IsInRole("CentreSupervisor"))
{


    @section Scripts {

    <script>
        $('#examinersTable').DataTable({
            "processing": true,
            "serverSide": true,
            "lengthMenu": [
                [10, 25, 50, 100, 250, 500, 1000],
                [10, 25, 50, 100, 250, 500, 1000]
            ],
            "pageLength": 10,
            "dom": '<"row mb-3"<"col-md-4"l><"col-md-4 text-center"B><"col-md-4"f>>' +
                '<t>' +
                '<"row mt-3"<"col-md-6"i><"col-md-6"p>>',
            "buttons": [
                {
                    extend: 'excelHtml5',
                    className: 'btn btn-sm btn-success',
                    text: '<i class="fa fa-file-excel" style="color: #28a745;"></i> Excel'
                },
                {
                    extend: 'csvHtml5',
                    className: 'btn btn-sm btn-info',
                    text: '<i class="fa fa-file-csv" style="color: #17a2b8;"></i> CSV'
                },
                {
                    extend: 'pdfHtml5',
                    className: 'btn btn-sm btn-danger',
                    text: '<i class="fa fa-file-pdf" style="color: #dc3545;"></i> PDF'
                }
            ],
            "ajax": {
                url: "/ExaminerScriptsMarked/GetTransactionData",
                type: "POST"
            },
            "columns": [
                { "data": "examinerNumber", "name": "ExaminerNumber", "autoWidth": true },
                { "data": "lastName", "name": "LastName", "autoWidth": true },
                { "data": "firstName", "name": "FirstName", "autoWidth": true },
                { "data": "category", "name": "Category", "autoWidth": true },
                { "data": "bms", "name": "BMS", "autoWidth": true },
                { "data": "activity", "name": "Activity", "autoWidth": true },
                { "data": "scriptMarked", "name": "ScriptsMarked", "autoWidth": true },
                { "data": "status", "name": "Status", "autoWidth": true },
            ],

        });

    </script>

    }
}


@if (User.IsInRole("Admin") || User.IsInRole("SuperAdmin"))
{



    @section Scripts {

    <script>
        $('#examinersTable').DataTable({
            "processing": true,
            "serverSide": true,
            "lengthMenu": [
                [10, 25, 50, 100, 250, 500, 1000],
                [10, 25, 50, 100, 250, 500, 1000]
            ],
            "pageLength": 10,
            "dom": '<"row mb-3"<"col-md-4"l><"col-md-4 text-center"B><"col-md-4"f>>' +
                '<t>' +
                '<"row mt-3"<"col-md-6"i><"col-md-6"p>>',
            "buttons": [
                {
                    extend: 'excelHtml5',
                    className: 'btn btn-sm btn-success',
                    text: '<i class="fa fa-file-excel" style="color: #28a745;"></i> Excel'
                },
                {
                    extend: 'csvHtml5',
                    className: 'btn btn-sm btn-info',
                    text: '<i class="fa fa-file-csv" style="color: #17a2b8;"></i> CSV'
                },
                {
                    extend: 'pdfHtml5',
                    className: 'btn btn-sm btn-danger',
                    text: '<i class="fa fa-file-pdf" style="color: #dc3545;"></i> PDF'
                }
            ],
            "ajax": {
                url: "/ExaminerScriptsMarked/GetTransactionData",
                type: "POST"
            },
            "columns": [
                { "data": "examinerNumber", "name": "ExaminerNumber", "autoWidth": true },
                { "data": "lastName", "name": "LastName", "autoWidth": true },
                { "data": "firstName", "name": "FirstName", "autoWidth": true },
                { "data": "category", "name": "Category", "autoWidth": true },
                { "data": "bms", "name": "BMS", "autoWidth": true },
                { "data": "activity", "name": "Activity", "autoWidth": true },
                { "data": "scriptMarked", "name": "ScriptsMarked", "autoWidth": true },
                { "data": "status", "name": "Status", "autoWidth": true },
            ],

        });

    </script>



    }
}





